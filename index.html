<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text-to-Speech App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- =============== CSS =============== -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .animate-spin-custom {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loading-message {
            font-size: 1.25rem;
            font-weight: 500;
            color: #93c5fd;
            text-align: center;
            margin-top: 1rem;
            animation: fadeInOut 2s infinite alternate;
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: #1e3a8a;
            border: 1px solid #3b82f6;
        }
        @keyframes fadeInOut {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }
        #audio-controls-container {
            background-color: rgba(30, 58, 138, 0.5); /* bg-blue-900 with opacity */
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
        }
        #player-controls-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }
        #player-controls-group button {
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #player-controls-group button:hover {
            transform: scale(1.1);
        }
        #player-controls-group button.disabled {
            color: #60a5fa;
            cursor: not-allowed;
            transform: scale(1);
        }
        #time-display {
            font-size: 0.875rem;
            color: #bfdbfe;
            white-space: nowrap;
        }
        #progress-bar-container {
            flex-grow: 1;
            height: 6px;
            background: #4b5563;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        #progress-bar {
            height: 100%;
            background: #60a5fa;
            border-radius: 3px;
            pointer-events: none;
        }
        #seek-handle {
           display: none; /* Hide the seek handle as requested */
        }
        #volume-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #volume-slider {
            width: 80px;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: #4b5563;
            border-radius: 2px;
            outline: none;
            transition: opacity .2s;
        }
        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }
        #volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }
        #language-switcher-icon {
            font-size: 1.5rem;
            color: #93c5fd;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        #language-switcher-icon:hover {
            color: #60a5fa;
            transform: scale(1.1);
        }
        #language-dropdown {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background-color: #1e3a8a;
            border: 1px solid #3b82f6;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 20;
            max-height: 200px;
            overflow-y: auto;
        }
        #language-dropdown div {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #language-dropdown div:hover {
            background-color: #3b82f6;
        }
        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1e3a8a;
            padding: 2rem;
            border-radius: 1rem;
            border: 1px solid #3b82f6;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-content h2 {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .modal-content h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .modal-content p, .modal-content ul {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #dbeafe;
        }
        .modal-content ul {
            list-style-position: inside;
            list-style-type: disc;
        }
    </style>
</head>
<body class="bg-blue-950 text-white transition-colors duration-300">

    <!-- =============== HTML =============== -->
    <div class="flex flex-col items-center justify-center min-h-screen">

        <!-- Language Switcher -->
        <div class="absolute top-4 right-4 z-10">
            <div class="relative flex items-center gap-2">
                <i id="language-switcher-icon" class="fas fa-globe"></i>
                <select id="language-select-top" class="hidden">
                    <option value="en-US">English</option>
                    <option value="ar">العربية</option>
                    <option value="fr-FR">Français</option>
                    <option value="tr-TR">Türkçe</option>
                    <option value="ru-RU">Русский</option>
                    <option value="id-ID">Bahasa Indonesia</option>
                    <option value="es-US">Español</option>
                    <option value="ja-JP">日本語</option>
                    <option value="ko-KR">한국어</option>
                    <option value="de-DE">Deutsch</option>
                    <option value="hi-IN">हिन्दी</option>
                    <option value="it-IT">Italiano</option>
                    <option value="pt-BR">Português</option>
                    <option value="nl-NL">Nederlands</option>
                    <option value="pl-PL">Polski</option>
                    <option value="vi-VN">Tiếng Việt</option>
                    <option value="th-TH">ไทย</option>
                    <option value="ro-RO">Română</option>
                    <option value="uk-UA">Українська</option>
                    <option value="bn-BD">বাংলা</option>
                    <option value="zh-CN">中文 (简体)</option>
                    <option value="sv-SE">Svenska</option>
                    <option value="el-GR">Ελληνικά</option>
                </select>
                <div id="language-dropdown" class="hidden"></div>
            </div>
        </div>

        <!-- Main App Container -->
        <div id="main-app" class="w-full max-w-xl bg-blue-900 rounded-2xl shadow-2xl shadow-blue-800/50 p-8 m-4 transition-transform duration-500 ease-in-out">
            <h1 class="text-3xl font-bold text-center text-white mb-2">Text-to-Speech & Summary App</h1>
            <p class="text-center text-blue-300 mb-8 text-sm md:text-base">Enter any text, choose your language and voice to generate audio.</p>

            <!-- Voice Selector -->
            <div class="w-full mb-4">
                <label for="voice-select" class="block text-sm font-medium text-blue-200 mb-2">Select Voice:</label>
                <select id="voice-select" class="w-full p-2 border-2 border-blue-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 bg-blue-800 text-white">
                    <option value="Orus">Orus (Normal)</option>
                    <option value="Rasalgethi">Rasalgethi (Announcer)</option>
                    <option value="Algenib">Algenib (Gravelly)</option>
                    <option value="Charon">Charon (NatGeo Style Announcer)</option>
                    <option value="Zubenelgenubi">Zubenelgenubi (BBC Style Announcer)</option>
                    <option value="Iapetus">Iapetus (Clear)</option>
                    <option value="Fenrir">Fenrir (Excitable)</option>
                </select>
            </div>

            <textarea id="text-input" class="w-full h-40 p-4 border-2 border-blue-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-400 bg-blue-800 text-white placeholder-blue-400 resize-none" placeholder="Enter your text here..."></textarea>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
                <button id="tts-button" class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-sky-600 to-blue-700 text-white font-semibold rounded-full shadow-lg hover:from-sky-700 hover:to-blue-800 transition-all duration-300 transform hover:scale-105">
                    <span id="tts-button-text">Play Audio</span>
                    <svg id="tts-spinner" class="animate-spin-custom h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <button id="summarize-button" class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-indigo-600 to-violet-700 text-white font-semibold rounded-full shadow-lg hover:from-indigo-700 hover:to-violet-800 transition-all duration-300 transform hover:scale-105">
                    <span id="summarize-button-text">✨ Summarize</span>
                    <svg id="summarize-spinner" class="animate-spin-custom h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <button id="rephrase-button" class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-emerald-600 to-teal-700 text-white font-semibold rounded-full shadow-lg hover:from-emerald-700 hover:to-teal-800 transition-all duration-300 transform hover:scale-105">
                    <span id="rephrase-button-text">✨ Rephrase</span>
                    <svg id="rephrase-spinner" class="animate-spin-custom h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <button id="download-button" class="hidden sm:flex items-center justify-center px-6 py-3 bg-gradient-to-r from-blue-400 to-cyan-500 text-white font-semibold rounded-full shadow-lg hover:from-blue-500 hover:to-cyan-600 transition-all duration-300 transform hover:scale-105">
                    <span>Download</span>
                </button>
            </div>

            <div id="loading-prayer" class="loading-message hidden"></div>

            <!-- Audio Player -->
            <div id="audio-controls-container" class="hidden mt-6">
                <div class="flex items-center gap-4 w-full mb-2">
                    <div id="progress-bar-container">
                        <div id="progress-bar" style="width: 0%;"></div>
                        <div id="seek-handle" style="left: 0%;"></div>
                    </div>
                </div>
                <div id="player-controls-group">
                    <button id="play-pause-button" class="disabled">
                        <i class="fas fa-play" id="play-icon"></i>
                        <i class="fas fa-pause" id="pause-icon" style="display: none;"></i>
                    </button>
                    <button id="rewind-button" class="disabled"><i class="fas fa-backward"></i></button>
                    <button id="forward-button" class="disabled"><i class="fas fa-forward"></i></button>
                    <div id="time-display" class="ml-2">
                        <span id="current-time">0:00</span> / <span id="duration">0:00</span>
                    </div>
                    <div class="flex-grow"></div> <!-- Spacer -->
                    <div id="volume-controls">
                        <button id="volume-button">
                            <i class="fas fa-volume-up" id="volume-icon-up"></i>
                            <i class="fas fa-volume-mute" id="volume-icon-mute" style="display: none;"></i>
                        </button>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
                    </div>
                </div>
            </div>

            <div id="summary-output" class="hidden mt-6 p-4 bg-blue-800 rounded-xl border border-blue-700">
                <h2 class="text-xl font-semibold text-white mb-2">Summary</h2>
                <p id="summary-text" class="text-blue-200 whitespace-pre-wrap"></p>
            </div>

            <div id="error-message" class="hidden mt-6 text-center text-red-300 bg-red-900 p-4 rounded-xl border border-red-600"></div>
        </div>

        <!-- Footer -->
        <footer class="w-full text-center py-4 text-sm text-blue-400">
            <p class="mb-2">&copy; 2024 Text-to-Speech App. All Rights Reserved.</p>
            <div class="flex justify-center gap-4">
                <a href="#" id="privacy-link" class="hover:text-white transition-colors">Privacy Policy</a>
                <a href="#" id="contact-link" class="hover:text-white transition-colors">Contact Us</a>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <div id="privacy-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <button id="privacy-modal-close" class="modal-close-btn">&times;</button>
            <div id="privacy-modal-body"></div>
        </div>
    </div>
    <div id="contact-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <button id="contact-modal-close" class="modal-close-btn">&times;</button>
            <div id="contact-modal-body"></div>
        </div>
    </div>


    <!-- =============== JAVASCRIPT =============== -->
    <script>
        // DOM Elements
        const textInput = document.getElementById('text-input');
        const ttsButton = document.getElementById('tts-button');
        const summarizeButton = document.getElementById('summarize-button');
        const rephraseButton = document.getElementById('rephrase-button');
        const downloadButton = document.getElementById('download-button');
        const voiceSelect = document.getElementById('voice-select');
        const languageSelect = document.getElementById('language-select-top');
        const summaryOutput = document.getElementById('summary-output');
        const summaryTextEl = document.getElementById('summary-text');
        const errorEl = document.getElementById('error-message');
        const ttsButtonText = document.getElementById('tts-button-text');
        const ttsSpinner = document.getElementById('tts-spinner');
        const summarizeButtonText = document.getElementById('summarize-button-text');
        const summarizeSpinner = document.getElementById('summarize-spinner');
        const rephraseButtonText = document.getElementById('rephrase-button-text');
        const rephraseSpinner = document.getElementById('rephrase-spinner');
        const loadingPrayerEl = document.getElementById('loading-prayer');
        const globeIcon = document.getElementById('language-switcher-icon');
        const languageDropdown = document.getElementById('language-dropdown');
        const audioControlsContainer = document.getElementById('audio-controls-container');
        const progressBar = document.getElementById('progress-bar');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const seekHandle = document.getElementById('seek-handle');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const playPauseButton = document.getElementById('play-pause-button');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const rewindButton = document.getElementById('rewind-button');
        const forwardButton = document.getElementById('forward-button');
        const volumeButton = document.getElementById('volume-button');
        const volumeIconUp = document.getElementById('volume-icon-up');
        const volumeIconMute = document.getElementById('volume-icon-mute');
        const volumeSlider = document.getElementById('volume-slider');
        const privacyLink = document.getElementById('privacy-link');
        const contactLink = document.getElementById('contact-link');

        // Modal elements
        const privacyModal = document.getElementById('privacy-modal');
        const contactModal = document.getElementById('contact-modal');
        const privacyModalBody = document.getElementById('privacy-modal-body');
        const contactModalBody = document.getElementById('contact-modal-body');
        const privacyModalClose = document.getElementById('privacy-modal-close');
        const contactModalClose = document.getElementById('contact-modal-close');

        // State variables
        let audioUrl = null;
        let audio = null;
        let isPlaying = false;
        let isAudioLoaded = false;
        let isSeeking = false;
        let lastVolume = 1;

        // --- Translations Object ---
        const translations = {
            'en-US': { title: 'Text-to-Speech & Summary App', subtitle: 'Enter any text, choose your language and voice to generate audio.', selectVoice: 'Select Voice:', placeholder: 'Enter your text here...', playButton: 'Generate Audio', summarizeButton: '✨ Summarize', rephraseButton: '✨ Rephrase', downloadButton: 'Download', summaryTitle: 'Summary', loading: 'Generating...', summarizeLoading: 'Summarizing...', rephraseLoading: 'Rephrasing...', loadingPrayer: 'Keep yourself busy with prayer upon the Prophet (PBUH)', errorNoText: 'Please enter some text.', errorAudio: 'Failed to process audio response.', errorSummary: 'Failed to generate summary.', errorRephrase: 'Failed to rephrase text.', privacy: 'Privacy Policy', contact: 'Contact Us', voiceOptions: { 'Orus': 'Orus (Normal)', 'Rasalgethi': 'Rasalgethi (Announcer)', 'Algenib': 'Algenib (Gravelly)', 'Charon': 'Charon (NatGeo Style Announcer)', 'Zubenelgenubi': 'Zubenelgenubi (BBC Style Announcer)', 'Iapetus': 'Iapetus (Clear)', 'Fenrir': 'Fenrir (Excitable)' }, langName: 'English', privacyContent: `<h2>Privacy Policy</h2><p>Last updated: August 27, 2025</p><p>This Privacy Policy describes Our policies and procedures on the collection, use and disclosure of Your information when You use the Service.</p><h3>Information Collection and Use</h3><p>We do not personally collect any identifiable information. However, our app utilizes third-party services that may collect information used to identify you.</p><h3>Third-Party Services</h3><p>Our Service may use third-party services, such as Google AdSense, for advertising. These third parties may use cookies or other tracking technologies to collect information about your use of our Service and other websites to provide you with targeted advertisements.</p><ul><li>Google's use of advertising cookies enables it and its partners to serve ads to your users based on their visit to your sites and/or other sites on the Internet.</li><li>Users may opt out of personalized advertising by visiting Ads Settings.</li></ul><h3>Changes to This Privacy Policy</h3><p>We may update Our Privacy Policy from time to time. We will notify You of any changes by posting the new Privacy Policy on this page.</p>`, contactContent: `<h2>Contact Us</h2><p>If you have any questions about this app, you can contact us:</p><ul><li>By email: contact.tts.app@example.com</li></ul>` },
            'ar': { title: 'تطبيق تحويل النص إلى كلام وتلخيص', subtitle: 'اكتب أي نص، اختر اللغة والصوت لتحويله إلى كلام.', selectVoice: 'اختر الصوت:', placeholder: 'اكتب هنا...', playButton: 'إنشاء الصوت', summarizeButton: '✨ تلخيص', rephraseButton: '✨ إعادة صياغة', downloadButton: 'تنزيل', summaryTitle: 'الملخص', loading: 'جاري الإنشاء...', summarizeLoading: 'جاري التلخيص...', rephraseLoading: 'جاري الصياغة...', loadingPrayer: 'اشغل انتظارك بالصلاة على النبي', errorNoText: 'الرجاء إدخال نص.', errorAudio: 'فشل في معالجة الصوت.', errorSummary: 'فشل في إنشاء الملخص.', errorRephrase: 'فشل في إعادة صياغة النص.', privacy: 'سياسة الخصوصية', contact: 'اتصل بنا', voiceOptions: { 'Orus': 'عادي', 'Rasalgethi': 'مذيع', 'Algenib': 'جدي', 'Charon': 'مذيع ناشيونال جيوغرافيك', 'Zubenelgenubi': 'مذيعBBC', 'Iapetus': 'صوت واضح', 'Fenrir': 'قوي' }, langName: 'Arabic', privacyContent: `<h2>سياسة الخصوصية</h2><p>آخر تحديث: 27 أغسطس 2025</p><p>تصف سياسة الخصوصية هذه سياساتنا وإجراءاتنا بشأن جمع معلوماتك واستخدامها والكشف عنها عند استخدامك للخدمة.</p><h3>جمع المعلومات واستخدامها</h3><p>نحن لا نجمع أي معلومات تعريف شخصية. ومع ذلك، يستخدم تطبيقنا خدمات جهات خارجية قد تجمع معلومات تستخدم للتعرف عليك.</p><h3>خدمات الجهات الخارجية</h3><p>قد تستخدم خدمتنا خدمات جهات خارجية، مثل Google AdSense، للإعلان. قد تستخدم هذه الجهات الخارجية ملفات تعريف الارتباط أو تقنيات التتبع الأخرى لجمع معلومات حول استخدامك لخدمتنا ومواقع الويب الأخرى لتزويدك بإعلانات مستهدفة.</p><ul><li>يمكّن استخدام Google لملفات تعريف الارتباط الإعلانية شركاءها من عرض الإعلانات للمستخدمين بناءً على زيارتهم لمواقعك و/أو مواقع أخرى على الإنترنت.</li><li>يمكن للمستخدمين إلغاء الاشتراك في الإعلانات المخصصة عن طريق زيارة إعدادات الإعلانات.</li></ul><h3>التغييرات على سياسة الخصوصية هذه</h3><p>قد نقوم بتحديث سياسة الخصوصية الخاصة بنا من وقت لآخر. سنخطرك بأي تغييرات عن طريق نشر سياسة الخصوصية الجديدة على هذه الصفحة.</p>`, contactContent: `<h2>اتصل بنا</h2><p>إذا كان لديك أي أسئلة حول هذا التطبيق، يمكنك الاتصال بنا:</p><ul><li>عبر البريد الإلكتروني: contact.tts.app@example.com</li></ul>` },
        };

        // --- UI Update Functions ---
        function populateLanguageDropdown() {
            languageDropdown.innerHTML = '';
            Array.from(languageSelect.options).forEach(option => {
                const langDiv = document.createElement('div');
                langDiv.textContent = option.textContent;
                langDiv.dataset.value = option.value;
                langDiv.addEventListener('click', () => {
                    languageSelect.value = option.value;
                    updateUI(option.value);
                    languageDropdown.classList.add('hidden');
                });
                languageDropdown.appendChild(langDiv);
            });
        }

        function updateUI(lang) {
            const t = translations[lang] || translations['en-US'];
            document.documentElement.lang = lang;
            document.documentElement.dir = ['ar', 'hi-IN', 'bn-BD'].includes(lang) ? 'rtl' : 'ltr';
            
            document.querySelector('h1').textContent = t.title;
            document.querySelector('p').textContent = t.subtitle;
            document.querySelector('label[for="voice-select"]').textContent = t.selectVoice;
            textInput.placeholder = t.placeholder;
            ttsButtonText.textContent = t.playButton;
            summarizeButtonText.textContent = t.summarizeButton;
            rephraseButtonText.textContent = t.rephraseButton;
            downloadButton.querySelector('span').textContent = t.downloadButton;
            document.querySelector('#summary-output h2').textContent = t.summaryTitle;
            loadingPrayerEl.textContent = t.loadingPrayer;
            privacyLink.textContent = t.privacy;
            contactLink.textContent = t.contact;
            privacyModalBody.innerHTML = t.privacyContent;
            contactModalBody.innerHTML = t.contactContent;

            const voiceOptions = t.voiceOptions;
            if (voiceOptions) {
                Array.from(voiceSelect.options).forEach(option => {
                    const voiceValue = option.value;
                    if (voiceOptions[voiceValue]) {
                        option.textContent = voiceOptions[voiceValue];
                    }
                });
            }
        }

        // --- Audio Processing and Player Logic ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * pcmData.BYTES_PER_ELEMENT;

            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, 36 + dataSize, true);
            view.setUint32(8, 0x57415645, false); // "WAVE"
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, dataSize, true);

            return new Blob([header, pcmData], { type: 'audio/wav' });
        }
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function updateProgress() {
            if (audio && !isSeeking && audio.duration) {
                const progressPercent = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
                currentTimeEl.textContent = formatTime(audio.currentTime);
            }
        }
        
        function seek(e) {
            if (!isAudioLoaded) return;
            const progressBarRect = progressBarContainer.getBoundingClientRect();
            const clientX = e.clientX ?? e.changedTouches?.[0]?.clientX;
            if (clientX === undefined) return;
            
            let offsetX = clientX - progressBarRect.left;
            offsetX = Math.max(0, Math.min(offsetX, progressBarRect.width));
            
            const percent = offsetX / progressBarRect.width;
            audio.currentTime = percent * audio.duration;
            updateProgress();
        }

        function setupAudioPlayer(url) {
            if (audio) {
                audio.pause();
                audio.src = '';
            }
            audio = new Audio(url);
            audio.volume = volumeSlider.value;
            isAudioLoaded = false;

            audio.addEventListener('loadedmetadata', () => {
                isAudioLoaded = true;
                durationEl.textContent = formatTime(audio.duration);
                [playPauseButton, rewindButton, forwardButton].forEach(btn => btn.classList.remove('disabled'));
                audio.play();
                isPlaying = true;
                updatePlayPauseIcon();
            });
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', () => {
                isPlaying = false;
                updatePlayPauseIcon();
                audio.currentTime = 0;
                updateProgress();
            });
        }
        
        function updatePlayPauseIcon() {
            playIcon.style.display = isPlaying ? 'none' : 'inline';
            pauseIcon.style.display = isPlaying ? 'inline' : 'none';
        }

        function updateVolumeIcon() {
            const isMuted = audio ? audio.volume === 0 : volumeSlider.value == 0;
            volumeIconUp.style.display = isMuted ? 'none' : 'inline';
            volumeIconMute.style.display = isMuted ? 'inline' : 'none';
        }

        // --- API Call Functions ---
        async function callApiWithExponentialBackoff(apiCall, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        async function generateContent(prompt) {
            const apiKey = ""; // Leave empty
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            return result.candidates[0].content.parts[0].text;
        }
        
        async function generateAudio(text, voice) {
            const apiKey = ""; // Leave empty
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/")) {
                const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                return URL.createObjectURL(wavBlob);
            } else {
                throw new Error("Invalid audio data in response");
            }
        }

        // --- Event Handlers ---
        function showError(messageKey) {
            const lang = languageSelect.value;
            errorEl.textContent = (translations[lang] || translations['en-US'])[messageKey] || 'An unknown error occurred.';
            errorEl.classList.remove('hidden');
        }

        function toggleButtonLoading(button, spinner, textEl, isLoading, loadingTextKey) {
            const lang = languageSelect.value;
            const t = translations[lang] || translations['en-US'];
            if (isLoading) {
                spinner.classList.remove('hidden');
                textEl.textContent = t[loadingTextKey];
                button.disabled = true;
            } else {
                spinner.classList.add('hidden');
                let originalTextKey;
                if (button.id === 'tts-button') originalTextKey = 'playButton';
                else if (button.id === 'summarize-button') originalTextKey = 'summarizeButton';
                else if (button.id === 'rephrase-button') originalTextKey = 'rephraseButton';
                textEl.textContent = t[originalTextKey];
                button.disabled = false;
            }
        }

        async function handleTts() {
            const text = textInput.value.trim();
            if (!text) {
                showError('errorNoText');
                return;
            }
            errorEl.classList.add('hidden');
            summaryOutput.classList.add('hidden');
            toggleButtonLoading(ttsButton, ttsSpinner, ttsButtonText, true, 'loading');
            loadingPrayerEl.classList.remove('hidden');

            try {
                const selectedVoice = voiceSelect.value;
                const url = await callApiWithExponentialBackoff(() => generateAudio(text, selectedVoice));
                audioUrl = url;
                downloadButton.classList.remove('hidden');
                audioControlsContainer.classList.remove('hidden');
                setupAudioPlayer(url);
            } catch (error) {
                console.error("TTS Error:", error);
                showError('errorAudio');
            } finally {
                toggleButtonLoading(ttsButton, ttsSpinner, ttsButtonText, false);
                loadingPrayerEl.classList.add('hidden');
            }
        }

        async function handleSummarize() {
            const text = textInput.value.trim();
            if (!text) {
                showError('errorNoText');
                return;
            }
            errorEl.classList.add('hidden');
            toggleButtonLoading(summarizeButton, summarizeSpinner, summarizeButtonText, true, 'summarizeLoading');
            
            try {
                const currentLang = languageSelect.value;
                const langName = (translations[currentLang] || translations['en-US']).langName;
                const prompt = `Summarize the following text in ${langName}: "${text}"`;
                const summary = await callApiWithExponentialBackoff(() => generateContent(prompt));
                summaryTextEl.textContent = summary;
                summaryOutput.classList.remove('hidden');
            } catch (error) {
                console.error("Summarize Error:", error);
                showError('errorSummary');
            } finally {
                toggleButtonLoading(summarizeButton, summarizeSpinner, summarizeButtonText, false);
            }
        }
        
        async function handleRephrase() {
            const text = textInput.value.trim();
            if (!text) {
                showError('errorNoText');
                return;
            }
            errorEl.classList.add('hidden');
            toggleButtonLoading(rephraseButton, rephraseSpinner, rephraseButtonText, true, 'rephraseLoading');

            try {
                const rephrasedText = await callApiWithExponentialBackoff(() => generateContent(`Rephrase this text: "${text}"`));
                textInput.value = rephrasedText;
            } catch (error) {
                console.error("Rephrase Error:", error);
                showError('errorRephrase');
            } finally {
                toggleButtonLoading(rephraseButton, rephraseSpinner, rephraseButtonText, false);
            }
        }

        // --- Event Listeners ---
        ttsButton.addEventListener('click', handleTts);
        summarizeButton.addEventListener('click', handleSummarize);
        rephraseButton.addEventListener('click', handleRephrase);
        downloadButton.addEventListener('click', () => {
            if (audioUrl) {
                const a = document.createElement('a');
                a.href = audioUrl;
                a.download = 'audio.wav';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        });

        globeIcon.addEventListener('click', () => {
            languageDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!globeIcon.contains(e.target) && !languageDropdown.contains(e.target)) {
                languageDropdown.classList.add('hidden');
            }
        });

        playPauseButton.addEventListener('click', () => {
            if (!isAudioLoaded) return;
            if (isPlaying) {
                audio.pause();
            } else {
                audio.play();
            }
            isPlaying = !isPlaying;
            updatePlayPauseIcon();
        });

        rewindButton.addEventListener('click', () => {
            if (isAudioLoaded) audio.currentTime = Math.max(0, audio.currentTime - 10);
        });

        forwardButton.addEventListener('click', () => {
            if (isAudioLoaded) audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
        });

        const startSeek = (e) => {
            if (!isAudioLoaded) return;
            isSeeking = true;
            seek(e);
            document.addEventListener('mousemove', seek);
            document.addEventListener('touchmove', seek);
            document.addEventListener('mouseup', endSeek);
            document.addEventListener('touchend', endSeek);
        };

        const endSeek = () => {
            if (isSeeking) {
                isSeeking = false;
                document.removeEventListener('mousemove', seek);
                document.removeEventListener('touchmove', seek);
                document.removeEventListener('mouseup', endSeek);
                document.removeEventListener('touchend', endSeek);
            }
        };

        progressBarContainer.addEventListener('mousedown', startSeek);
        progressBarContainer.addEventListener('touchstart', startSeek, { passive: true });

        volumeSlider.addEventListener('input', (e) => {
            if (audio) {
                audio.volume = e.target.value;
            }
            lastVolume = e.target.value;
            if (lastVolume > 0 && audio && audio.muted) {
                audio.muted = false;
            }
            updateVolumeIcon();
        });

        volumeButton.addEventListener('click', () => {
            if (!audio) return;
            if (audio.volume > 0) {
                lastVolume = audio.volume;
                audio.volume = 0;
                volumeSlider.value = 0;
            } else {
                audio.volume = lastVolume;
                volumeSlider.value = lastVolume;
            }
            updateVolumeIcon();
        });

        // Modal event listeners
        privacyLink.addEventListener('click', (e) => {
            e.preventDefault();
            privacyModal.classList.remove('hidden');
        });
        contactLink.addEventListener('click', (e) => {
            e.preventDefault();
            contactModal.classList.remove('hidden');
        });
        privacyModalClose.addEventListener('click', () => privacyModal.classList.add('hidden'));
        contactModalClose.addEventListener('click', () => contactModal.classList.add('hidden'));
        privacyModal.addEventListener('click', (e) => {
            if (e.target === privacyModal) privacyModal.classList.add('hidden');
        });
        contactModal.addEventListener('click', (e) => {
            if (e.target === contactModal) contactModal.classList.add('hidden');
        });


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            populateLanguageDropdown();
            const defaultLang = 'ar';
            languageSelect.value = defaultLang;
            updateUI(defaultLang);
        });
    </script>
</body>
</html>
